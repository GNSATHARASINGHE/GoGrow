<!-- File: crop-recommendation.html (with dark theme toggle) -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover"
  />
  <title>Crop Recommendation</title>

  <!-- üîí user-only guard -->
  <script>
    (function guard() {
      const role = localStorage.getItem("role");
      if (role !== "user") {
        window.location.replace("view-posts.html");
      }
    })();
  </script>

  <style>
    :root{
      --bg:#f4f6f8; --card:#ffffff; --ink:#333; --muted:#6b7280;
      --brand:#009688; --accent:#2563eb; --weather:#e0f7fa;
      --radius:14px; --shadow:0 4px 12px rgba(0,0,0,.08);
      --gap:14px; --danger:#b91c1c; --danger-soft: rgba(239,68,68,.15);
      --border:#d1d5db; --input-bg:#ffffff;
    }
    /* üåô Dark theme tokens */
    :root[data-theme="dark"]{
      --bg:#0f1216; --card:#161b20; --ink:#e3e7ea; --muted:#9aa4af;
      --brand:#2b5445; --accent:#8ab4ff; --weather:#12232b;
      --shadow:0 4px 14px rgba(0,0,0,.6);
      --border:#2a2f37; --input-bg:#0f141a;
    }

    *{
      box-sizing:border-box;
      transition: background-color .25s ease, color .25s ease, border-color .25s ease, box-shadow .25s ease;
    }
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--ink);
      font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      padding:max(16px, env(safe-area-inset-top)) max(16px, env(safe-area-inset-right))
              max(16px, env(safe-area-inset-bottom)) max(16px, env(safe-area-inset-left));
    }
    .container{
      position:relative;
      max-width:800px; margin:0 auto; background:var(--card);
      border-radius:var(--radius); box-shadow:var(--shadow);
      padding:clamp(16px, 2.5vw, 24px);
    }
    h2{ margin:0 0 12px; font-size:clamp(20px, 2.5vw, 28px); line-height:1.2; }

    /* üåô Icon-only theme toggle (top-right in the card) */
    .theme-toggle{
      position:absolute; top:12px; right:12px;
      width:38px; height:38px; border-radius:50%; border:0;
      display:grid; place-items:center; font-size:20px; cursor:pointer;
      background: var(--brand); color:#fff; box-shadow: var(--shadow);
      transition: transform .12s ease, opacity .2s ease, background-color .25s ease;
    }
    .theme-toggle:hover{ opacity:.92; }
    .theme-toggle:active{ transform: scale(.96); }

    .weather-box{
      background:var(--weather); border-radius:10px; padding:14px 16px;
      box-shadow:0 2px 8px rgba(0,0,0,.08); margin:8px 0 18px;
    }
    .weather-box h4{ margin:0 0 6px; font-size:clamp(14px, 2.2vw, 16px); color:#00796b; font-weight:600; }
    :root[data-theme="dark"] .weather-box h4{ color:#70e1ff; }
    .weather-header{ text-align:center; margin:8px 0; }
    .weather-temp{ font-size:clamp(24px, 5.2vw, 32px); font-weight:800; color:var(--accent); }
    .weather-stats{
      display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; font-size:clamp(13px, 2.2vw, 14px);
    }
    .weather-stats div{ text-align:center; background:rgba(255,255,255,.55); border-radius:8px; padding:8px 6px; }
    :root[data-theme="dark"] .weather-stats div{ background:rgba(255,255,255,.06); }

    @media (max-width: 480px){ .weather-stats{ grid-template-columns: repeat(2, 1fr); } }

    form{ display:grid; gap:var(--gap); margin-top:6px; }
    .form-grid{ display:grid; gap:var(--gap); grid-template-columns: 1fr; }
    @media (min-width: 520px){
      .form-grid.cols-2{ grid-template-columns: 1fr 1fr; }
    }
    .field{ display:flex; flex-direction:column; gap:6px; }
    label{ font-size:13px; color:var(--muted); }

    input[type="number"], select, input[list]{
      width:100%; padding:12px; border-radius:10px; border:1px solid var(--border);
      font-size:16px; background:var(--input-bg); color:var(--ink); outline:none; transition:border-color .15s ease;
    }
    input[type="number"]:focus, select:focus, input[list]:focus{
      border-color:var(--brand); box-shadow:0 0 0 3px rgba(0,150,136,.12);
    }
    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0; }

    button[type="submit"]{
      width:100%; padding:14px 16px; border-radius:10px; border:none;
      background:var(--brand); color:#fff; font-weight:800; font-size:16px;
      cursor:pointer; transition:transform .05s ease, opacity .2s ease, box-shadow .2s ease;
      box-shadow:0 6px 14px rgba(0,150,136,.25);
    }
    button[type="submit"]:active{ transform:translateY(1px); }
    button[type="submit"]:disabled{ opacity:.7; cursor:not-allowed; box-shadow:none; }

    #recommendResult{ margin-top:8px; font-weight:800; font-size:clamp(14px, 2.4vw, 16px); }
    a.back{ display:inline-block; margin-top:12px; color:#00796b; text-decoration:none; font-weight:600; padding:8px 0; }
    a.back:hover{ text-decoration:underline; }
    :root[data-theme="dark"] a.back{ color:#4dd0e1; }

    .form-error{ margin-top:4px; color:var(--danger); font-weight:700; font-size:14px; }
    .is-invalid{ border-color:#ef4444 !important; box-shadow:0 0 0 3px var(--danger-soft) !important; }

    .toplist{ margin-top:8px; padding:10px; background:#f9fafb; border-radius:10px; border:1px solid #e5e7eb; }
    .toplist h4{ margin:0 0 6px; font-size:14px; color:#111827; }
    .toplist ul{ margin:0; padding-left:18px; font-size:14px; }
    :root[data-theme="dark"] .toplist{ background:#151a21; border-color:#2a2f37; }
    :root[data-theme="dark"] .toplist h4{ color:#e3e7ea; }
  </style>
</head>
<body>
  <div class="container">
    <!-- üåô Theme button -->
    <button id="themeToggle" class="theme-toggle" aria-label="Toggle theme">üåô</button>

    <h2>üå± Crop Recommendation</h2>

    <!-- Optional weather info (informational only; not used by the model) -->
    <div id="rec-weather" class="weather-box">
      <p>Getting weather data...</p>
    </div>

    <!-- ‚úÖ MODEL-COMPATIBLE INPUTS -->
    <form id="cropForm" novalidate>
      <div class="form-grid cols-2">
        <!-- Location -->
        <div class="field">
          <label for="inLocation">Location (District)</label>
          <input id="inLocation" name="Location" list="dl-locations" placeholder="Select or type‚Ä¶" required />
          <datalist id="dl-locations">
            <option value="Ratnapura"></option>
            <option value="Kegalle"></option>
          </datalist>
        </div>

        <!-- Season / Time -->
        <div class="field">
          <label for="inTime">Season</label>
          <select id="inTime" name="Time" required>
            <option value="" disabled selected>Select season</option>
            <option value="Yala">Yala</option>
            <option value="Maha">Maha</option>
          </select>
        </div>
      </div>

      <div class="form-grid cols-2">
        <!-- Soil Condition -->
        <div class="field">
          <label for="inSoil">Soil Condition</label>
          <input id="inSoil" name="Soil Condition" list="dl-soils" placeholder="e.g., Sandy loam" required />
          <datalist id="dl-soils">
            <option value="Sandy loam"></option>
            <option value="Sandy clay loam"></option>
            <option value="Alluvial soil"></option>
            <option value="Loam"></option>
            <option value="Clay loam"></option>
            <option value="Sandy"></option>
          </datalist>
        </div>

        <!-- pH -->
        <div class="field">
          <label for="inPh">Soil pH</label>
          <input id="inPh" type="number" name="pH" placeholder="e.g., 6.5" min="3" max="9" step="0.1" inputmode="decimal" required />
        </div>
      </div>

      <button type="submit">Get Recommendation</button>
    </form>

    <p id="formError" class="form-error" role="alert" aria-live="polite"></p>

    <p id="recommendResult" role="status" aria-live="polite"></p>
    <div id="topK" class="toplist" style="display:none;">
      <h4>Top suggestions</h4>
      <ul id="topKList"></ul>
    </div>

    <a class="back" href="view-posts.html">‚Üê Back to Posts</a>
  </div>

  <script>
    // üåô Theme toggle (persistent)
    (function(){
      const btn = document.getElementById('themeToggle');
      const saved = localStorage.getItem('theme')
        || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
      setTheme(saved);

      btn.addEventListener('click', ()=>{
        const next = (document.documentElement.dataset.theme === 'dark') ? 'light' : 'dark';
        setTheme(next);
      });

      function setTheme(t){
        document.documentElement.setAttribute('data-theme', t);
        localStorage.setItem('theme', t);
        btn.textContent = (t === 'dark') ? '‚òÄÔ∏è' : 'üåô';
      }
    })();

    // üå¶Ô∏è Optional weather card (informational only)
    const WEATHER_API_KEY = 'e8e2f1628840824475b2005d08244c4f';

    function renderWeather(data, box){
      box.innerHTML = `
        <h4>üå¶Ô∏è Weather in Your Area</h4>
        <div class="weather-header">
          <div class="weather-temp">${Number(data.main.temp).toFixed(1)} ¬∞C</div>
        </div>
        <div class="weather-stats">
          <div><strong>Humidity:</strong> ${Number(data.main.humidity).toFixed(0)}%</div>
          <div><strong>Clouds:</strong> ${data.clouds?.all ?? '‚Äî'}%</div>
          <div><strong>Wind:</strong> ${data.wind?.speed ?? '‚Äî'} m/s</div>
        </div>`;
    }

    async function loadWeather(){
      const box = document.getElementById('rec-weather');
      if(!("geolocation" in navigator)){
        box.innerHTML = `<p>‚ö†Ô∏è Geolocation not supported by browser.</p>`;
        return;
      }
      navigator.geolocation.getCurrentPosition(async pos=>{
        const {latitude:lat, longitude:lon} = pos.coords;
        try{
          const r = await fetch(
            `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${WEATHER_API_KEY}&units=metric`
          );
          const data = await r.json();
          if (!r.ok || (data && data.cod && +data.cod !== 200)) throw new Error(data?.message || 'Weather API error');
          renderWeather(data, box);
        }catch(e){
          console.error(e); box.innerHTML = `<p>‚ö†Ô∏è Could not load weather data.</p>`;
        }
      }, ()=>{ box.innerHTML = `<p>‚ö†Ô∏è Location access denied. Weather not available.</p>`; });
    }

    // ‚úÖ Form handling (validates & calls your API)
    const form = document.getElementById('cropForm');
    const errorEl = document.getElementById('formError');
    const resultEl = document.getElementById('recommendResult');
    const topK = document.getElementById('topK');
    const topKList = document.getElementById('topKList');

    // Clear errors on input
    form.querySelectorAll('input, select').forEach(inp=>{
      inp.addEventListener('input', ()=>{
        inp.classList.remove('is-invalid');
        if (errorEl.textContent) errorEl.textContent = '';
      });
      inp.addEventListener('change', ()=>{
        inp.classList.remove('is-invalid');
        if (errorEl.textContent) errorEl.textContent = '';
      });
    });

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      errorEl.textContent = '';
      resultEl.textContent = '';
      topK.style.display = 'none';
      topKList.innerHTML = '';

      if (!form.checkValidity()) {
        form.querySelectorAll('input[required], select[required]').forEach(inp=>{
          if (!inp.checkValidity()) inp.classList.add('is-invalid');
        });
        form.reportValidity();
        errorEl.textContent = 'Please fill all required fields (Location, Season, Soil Condition, pH).';
        return;
      }

      const payload = {
        "Location": document.getElementById('inLocation').value.trim(),
        "Time": document.getElementById('inTime').value,
        "Soil Condition": document.getElementById('inSoil').value.trim(),
        "pH": Number(document.getElementById('inPh').value)
      };

      if (!Number.isFinite(payload["pH"])) {
        errorEl.textContent = 'Please enter a valid numeric pH value.'; 
        document.getElementById('inPh').classList.add('is-invalid');
        return;
      }

      const btn = form.querySelector('button[type="submit"]');
      btn.disabled = true; btn.textContent = 'Processing...';

      try {
        const res = await fetch('/api/crop/recommend', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error(await res.text() || 'Request failed');
        const data = await res.json();

        const name = data.recommended_crop || data.pred || data.crop || '‚Äî';
        resultEl.textContent = 'Recommended Crop: ' + name;

        if (Array.isArray(data.top3) && data.top3.length) {
          topK.style.display = 'block';
          topKList.innerHTML = data.top3.map(x=>{
            const label = x.crop ?? x.label ?? x.name ?? '‚Äî';
            const p = (typeof x.prob === 'number') ? ` ‚Äî ${(x.prob*100).toFixed(1)}%` : '';
            return `<li>${label}${p}</li>`;
          }).join('');
        }
      } catch (err) {
        console.error(err);
        errorEl.textContent = 'Error: Unable to get recommendation. Please try again.';
      } finally {
        btn.disabled = false; btn.textContent = 'Get Recommendation';
      }
    });

    document.addEventListener('DOMContentLoaded', loadWeather);
  </script>
</body>
</html>
