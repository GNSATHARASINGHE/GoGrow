<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>GoGrow Chat List</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #f0f2f5;
      --card: #ffffff;
      --text: #222;
      --nav: #009688;
      --badge: #25d366;
    }

    body.dark {
      --bg: #121212;
      --card: #1f1f1f;
      --text: #ddd;
      --nav: #00796b;
      --badge: #26a69a;
    }

    /* smooth theme swap */
    * {
      transition: background-color .25s ease, color .25s ease, border-color .25s ease, box-shadow .25s ease;
    }

    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      background-color: var(--bg);
      color: var(--text);
    }

    .navbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background-color: var(--nav);
      color: white;
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 1000;
    }

    .navbar h2 {
      margin: 0;
      font-size: 18px;
    }

    .chat-list-container {
      max-width: 600px;
      margin: 10px auto 0;
      background-color: var(--card);
      min-height: 100vh;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
    }

    .chat-item {
      display: flex;
      align-items: center;
      padding: 14px;
      border-bottom: 1px solid #ddd;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .chat-item:hover {
      background-color: rgba(0,0,0,0.05);
    }

    .chat-item.unread {
      background-color: rgba(76, 175, 80, 0.07);
    }

    .profile-pic {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 12px;
    }

    .chat-info {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .chat-header {
      display: flex;
      justify-content: space-between;
      font-weight: 600;
      font-size: 16px;
    }

    .chat-timestamp {
      font-size: 13px;
      text-align: right;
    }

    .chat-message {
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      color: #777;
      margin-top: 4px;
      align-items: center;
    }

    .unread-badge {
      background-color: var(--badge);
      color: white;
      border-radius: 12px;
      padding: 2px 8px;
      font-size: 12px;
      margin-left: 8px;
    }

    .star {
      font-size: 18px;
      margin-left: 10px;
      color: gold;
      cursor: pointer;
    }

    .star.inactive {
      color: #ccc;
    }

    #searchInput, #newChatInput {
      width: 90%;
      margin: 10px auto;
      padding: 10px;
      display: block;
      font-size: 15px;
      border-radius: 8px;
      border: 1px solid #ccc;
      outline: none;
    }

    .top-controls {
      margin-top: 60px;
      text-align: center;
    }

    .toggle-btn {
      background: white;
      border: none;
      color: var(--nav);
      font-weight: bold;
      padding: 6px 10px;
      border-radius: 6px;
      margin-left: 12px;
      cursor: pointer;
    }

    /* make ONLY the moon button round & icon-only like other pages */
    #themeToggleBtn{
      width: 36px;
      height: 36px;
      border-radius: 50%;
      padding: 0;
      display: grid;
      place-items: center;
      font-size: 18px;
      font-weight: 700;
      border: none;
      cursor: pointer;
      background: #ffffff;       /* light */
      color: var(--nav);
      box-shadow: 0 2px 8px rgba(0,0,0,.15);
    }
    body.dark #themeToggleBtn{
      background: #2b5445;       /* dark accent to match other UIs */
      color: #fff;
    }
    #themeToggleBtn:hover{ opacity:.9; }
    #themeToggleBtn:active{ transform: scale(.96); }

    .unread-count {
      background-color: var(--badge);
      color: white;
      font-size: 13px;
      font-weight: bold;
      padding: 4px 10px;
      border-radius: 20px;
    }
  </style>
</head>
<body>
  <div class="navbar">
    <button onclick="goBack()" class="toggle-btn">‚Üê Back</button>
    <h2>Messages</h2>
    <div>
      <span id="unreadCount" class="unread-count" style="display:none;">0</span>
      <!-- give an id so we can style & swap icon -->
      <button id="themeToggleBtn" onclick="toggleDark()" class="toggle-btn">üåô</button>
    </div>
  </div>

  <div class="top-controls">
    <input type="text" id="searchInput" placeholder="üîç Search chat by name..." oninput="filterChats()" />
    <input type="text" id="newChatInput" placeholder="üí¨ Start new chat with username..." onkeydown="startNewChat(event)" />
  </div>

  <div class="chat-list-container" id="chatList"></div>

  <script>
    // set initial theme (persisted or system)
    (function initTheme(){
      const saved = localStorage.getItem('theme')
        || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
      if (saved === 'dark') document.body.classList.add('dark');
      const btn = document.getElementById('themeToggleBtn');
      if (btn) btn.textContent = document.body.classList.contains('dark') ? '‚òÄÔ∏è' : 'üåô';
    })();

    function toggleDark(){
      const isDark = document.body.classList.toggle('dark');
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
      const btn = document.getElementById('themeToggleBtn');
      if (btn) btn.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
    }

    const userId = localStorage.getItem('username');
    if (!userId) {
      alert("Please login first.");
      window.location.href = 'index.html';
    }

    let allChats = [];
    let allUsers = [];

    fetch(`/api/all-users`)
      .then(res => res.json())
      .then(data => {
        allUsers = data.filter(u => u !== userId);
      });

    function fetchAndRenderChats() {
      fetch(`/api/chat-list/${userId}`)
        .then(res => res.json())
        .then(data => {
          allChats = data;
          renderChats(sortChats(data));
        });
    }

    fetchAndRenderChats();
    setInterval(fetchAndRenderChats, 5000);

    function goBack() {
      window.location.href = 'view-posts.html';
    }

    function formatChatDateTime(isoString) {
      const msgDate = new Date(isoString);
      const now = new Date();
      return msgDate.toDateString() === now.toDateString()
        ? `<div class="chat-timestamp">${msgDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>`
        : `<div class="chat-timestamp">${msgDate.toLocaleDateString()}<br>${msgDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>`;
    }

    function createProfileImg(partner) {
      const img = document.createElement('img');
      img.className = 'profile-pic';
      const cachedExt = localStorage.getItem(`profile_${partner}`);
      if (cachedExt) {
        img.src = `/uploads/${partner}.${cachedExt}`;
        img.onerror = () => {
          localStorage.removeItem(`profile_${partner}`);
          img.src = '/images/default-user.png';
        };
        return img;
      }
      img.src = '/images/default-user.png';
      const extensions = ['jpg', 'jpeg', 'png', 'webp'];
      let index = 0;
      function tryNext() {
        if (index >= extensions.length) return;
        const ext = extensions[index++];
        const testPath = `/uploads/${partner}.${ext}`;
        const testImg = new Image();
        testImg.onload = () => {
          localStorage.setItem(`profile_${partner}`, ext);
          img.src = testPath;
        };
        testImg.onerror = tryNext;
        testImg.src = testPath;
      }
      tryNext();
      return img;
    }

    function renderChats(chats) {
      const container = document.getElementById('chatList');
      container.innerHTML = '';
      const unreadCounter = document.getElementById('unreadCount');
      let unreadCount = 0;

      chats.forEach(chat => {
        const chatItem = document.createElement('div');
        chatItem.className = 'chat-item';
        if (chat.unread === true) {
          chatItem.classList.add('unread');
          unreadCount++;
        }
        const img = createProfileImg(chat.partner);
        const info = document.createElement('div');
        info.className = 'chat-info';
        info.innerHTML = `
          <div class="chat-header">
            <span>${chat.partner}</span>
            ${formatChatDateTime(chat.time)}
          </div>
          <div class="chat-message">
            <span>${chat.lastMessage}</span>
            ${chat.unread === true ? `<span class="unread-badge">New</span>` : ''}
          </div>
        `;
        const isPinned = JSON.parse(localStorage.getItem('pinnedChats') || '[]').includes(chat.partner);
        const star = document.createElement('span');
        star.className = 'star ' + (isPinned ? '' : 'inactive');
        star.innerHTML = '‚òÖ';
        star.onclick = e => {
          e.stopPropagation();
          let pinned = JSON.parse(localStorage.getItem('pinnedChats') || '[]');
          if (pinned.includes(chat.partner)) {
            pinned = pinned.filter(p => p !== chat.partner);
          } else {
            pinned.unshift(chat.partner);
          }
          localStorage.setItem('pinnedChats', JSON.stringify(pinned));
          renderChats(sortChats(allChats));
        };
        chatItem.appendChild(img);
        chatItem.appendChild(info);
        chatItem.appendChild(star);
        chatItem.onclick = () => {
          window.location.href = `chat.html?receiver=${encodeURIComponent(chat.partner)}`;
        };
        container.appendChild(chatItem);
      });

      unreadCounter.innerText = unreadCount;
      unreadCounter.style.display = unreadCount > 0 ? 'inline-block' : 'none';
    }

    function sortChats(chats) {
      const pinned = JSON.parse(localStorage.getItem('pinnedChats') || '[]');
      return chats.sort((a, b) => {
        const isPinnedA = pinned.includes(a.partner);
        const isPinnedB = pinned.includes(b.partner);
        if (isPinnedA && !isPinnedB) return -1;
        if (!isPinnedA && isPinnedB) return 1;
        return new Date(b.time) - new Date(a.time);
      });
    }

    function filterChats() {
      const term = document.getElementById('searchInput').value.toLowerCase();
      renderChats(sortChats(allChats.filter(chat => chat.partner.toLowerCase().includes(term))));
    }

    function startNewChat(event) {
      if (event.key === 'Enter') {
        event.preventDefault();
        const input = event.target.value.trim();
        if (input && input !== userId && allUsers.includes(input)) {
          window.location.href = `chat.html?receiver=${encodeURIComponent(input)}`;
        } else {
          alert('‚ùå User not found or invalid.');
        }
      }
    }
  </script>
</body>
</html>
